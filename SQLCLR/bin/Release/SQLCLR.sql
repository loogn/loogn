/*
BaBai 的部署脚本
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, QUOTED_IDENTIFIER ON;

SET CONCAT_NULL_YIELDS_NULL, NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "BaBai"
:setvar DefaultDataPath "D:\Program Files\Microsoft SQL Server\MSSQL10.MSSQLSERVER\MSSQL\DATA\"
:setvar DefaultLogPath "D:\Program Files\Microsoft SQL Server\MSSQL10.MSSQLSERVER\MSSQL\DATA\"

GO
:on error exit
GO
USE [master]
GO
USE [$(DatabaseName)]
GO
IF EXISTS (SELECT * FROM tempdb..sysobjects WHERE id=OBJECT_ID('tempdb..#tmpErrors')) DROP TABLE #tmpErrors
GO
CREATE TABLE #tmpErrors (Error int)
GO
SET XACT_ABORT ON
GO
SET TRANSACTION ISOLATION LEVEL READ COMMITTED
GO
BEGIN TRANSACTION
GO
PRINT N'正在创建 [SQLCLR]...';


GO
CREATE ASSEMBLY [SQLCLR]
    AUTHORIZATION [dbo]
    FROM 0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C01030040440C520000000000000000E00002210B0108000008000000060000000000001E270000002000000040000000004000002000000002000004000000000000000400000000000000008000000002000000000000030040850000100000100000000010000010000000000000100000000000000000000000C826000053000000004000006003000000000000000000000000000000000000006000000C00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E7465787400000024070000002000000008000000020000000000000000000000000000200000602E72737263000000600300000040000000040000000A0000000000000000000000000000400000402E72656C6F6300000C0000000060000000020000000E0000000000000000000000000000400000420000000000000000000000000000000000270000000000004800000002000500B82000001006000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000009E0F00FE16030000016F0E00000A0F01FE16030000016F0E00000A1F21280F00000A731000000A2AD20F00FE16030000016F0E00000A0F01FE16030000016F0E00000A0F02FE16030000016F0E00000A1F21281100000A731200000A2A1E02281300000A2A00000042534A4201000100000000000C00000076322E302E35303732370000000005006C00000024020000237E000090020000B802000023537472696E6773000000004805000008000000235553005005000010000000234755494400000060050000B000000023426C6F620000000000000002000001471500000900000000FA2533001600000100000012000000020000000300000005000000130000000C000000010000000300000000000A0001000000000006002E0027000A00560041000A00610041000600B700A5000600CE00A5000600EB00A50006000A01A50006002301A50006003C01A50006005701A50006007201A5000600AA018B010600BE01A5000600F701D70106001702D7010A0057023C020E00940275020E009A0275020000000001000000000001000100010010001500000005000100010050200000000096006B000A0001007820000000009600780013000300AD2000000000861885001E000600000001008B00000002009100000001008B00000002009100000003009900210085002200290085002200310085002200390085002200410085002200490085002200510085002200590085002200610085002700690085002200710085002C00790085001E00810085001E0009006C0236008900A7023A001100850027008900AF024200190085002200090085001E0020006B0031002E0023005D002E000B004B002E00130057002E001B0057002E003B0057002E0063008E002E00330068002E002B004B002E004B0057002E005B00850040006B00310004800000010000006F13604D0000000000003502000002000000000000000000000001001E0000000000020000000000000000000000010035000000000002000000000000000000000001002700000000000000003C4D6F64756C653E0053514C434C522E646C6C00526567657846756E006D73636F726C69620053797374656D004F626A6563740053797374656D2E446174610053797374656D2E446174612E53716C54797065730053716C426F6F6C65616E0053716C537472696E6700526567657849734D617463680052656765785265706C616365002E63746F7200696E707574007061747465726E007265706C6163656D656E740053797374656D2E5265666C656374696F6E00417373656D626C795469746C6541747472696275746500417373656D626C794465736372697074696F6E41747472696275746500417373656D626C79436F6E66696775726174696F6E41747472696275746500417373656D626C79436F6D70616E7941747472696275746500417373656D626C7950726F6475637441747472696275746500417373656D626C79436F7079726967687441747472696275746500417373656D626C7954726164656D61726B41747472696275746500417373656D626C7943756C747572654174747269627574650053797374656D2E52756E74696D652E496E7465726F70536572766963657300436F6D56697369626C6541747472696275746500417373656D626C7956657273696F6E4174747269627574650053797374656D2E52756E74696D652E436F6D70696C6572536572766963657300436F6D70696C6174696F6E52656C61786174696F6E734174747269627574650052756E74696D65436F6D7061746962696C6974794174747269627574650053514C434C52004D6963726F736F66742E53716C5365727665722E5365727665720053716C46756E6374696F6E41747472696275746500546F537472696E670053797374656D2E546578742E526567756C617245787072657373696F6E730052656765780052656765784F7074696F6E730049734D61746368005265706C616365000000032000000000009C217B45FD708A42BB554E9A50450F8E0008B77A5C561934E0890800021109110D110D0A0003110D110D110D110D03200001042001010E0420010102042001010804010000000320000E070003020E0E11490800040E0E0E0E11490B01000653514C434C5200000501000000000A0100054348494E4100001C010017436F7079726967687420C2A9204348494E41203230313300000801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F777301000000F026000000000000000000000E2700000020000000000000000000000000000000000000000000000027000000000000000000000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C0000000000FF25002040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100100000001800008000000000000000000000000000000100010000003000008000000000000000000000000000000100000000004800000058400000080300000000000000000000080334000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE0000010000000100604D6F1300000100604D6F133F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B00468020000010053007400720069006E006700460069006C00650049006E0066006F0000004402000001003000300030003000300034006200300000002C000600010043006F006D00700061006E0079004E0061006D006500000000004300480049004E0041000000380007000100460069006C0065004400650073006300720069007000740069006F006E0000000000530051004C0043004C0052000000000040000F000100460069006C006500560065007200730069006F006E000000000031002E0030002E0034003900370035002E00310039003800300038000000000038000B00010049006E007400650072006E0061006C004E0061006D0065000000530051004C0043004C0052002E0064006C006C00000000005400170001004C006500670061006C0043006F007000790072006900670068007400000043006F0070007900720069006700680074002000A90020004300480049004E004100200032003000310033000000000040000B0001004F0072006900670069006E0061006C00460069006C0065006E0061006D0065000000530051004C0043004C0052002E0064006C006C0000000000300007000100500072006F0064007500630074004E0061006D00650000000000530051004C0043004C0052000000000044000F000100500072006F006400750063007400560065007200730069006F006E00000031002E0030002E0034003900370035002E00310039003800300038000000000048000F00010041007300730065006D0062006C0079002000560065007200730069006F006E00000031002E0030002E0034003900370035002E00310039003800300038000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000C000000203700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
    WITH PERMISSION_SET = SAFE;


GO
IF @@ERROR <> 0
   AND @@TRANCOUNT > 0
    BEGIN
        ROLLBACK;
    END

IF @@TRANCOUNT = 0
    BEGIN
        INSERT  INTO #tmpErrors (Error)
        VALUES                 (1);
        BEGIN TRANSACTION;
    END


GO
PRINT N'正在将文件添加到程序集 [SQLCLR] 中';


GO
ALTER ASSEMBLY [SQLCLR]
    DROP FILE ALL
    ADD FILE FROM 0xEFBBBF7573696E672053797374656D3B0D0A7573696E672053797374656D2E446174613B0D0A7573696E672053797374656D2E446174612E53716C436C69656E743B0D0A7573696E672053797374656D2E446174612E53716C54797065733B0D0A7573696E67204D6963726F736F66742E53716C5365727665722E5365727665723B0D0A7573696E672053797374656D2E546578742E526567756C617245787072657373696F6E733B0D0A0D0A7075626C6963207061727469616C20636C61737320526567657846756E0D0A7B0D0A202020202F2FE9AA8CE8AF81E5AD97E7ACA6E4B8B2E4B8ADE698AFE590A6E58C85E590ABE4B88EE68C87E5AE9AE79A84E58CB9E9858DE6A8A1E5BC8FE4B880E887B4E79A84E5AD97E7ACA6E4B8B20D0A202020205B53716C46756E6374696F6E5D0D0A202020207075626C6963207374617469632053716C426F6F6C65616E20526567657849734D617463682853716C537472696E6720696E7075742C53716C537472696E67207061747465726E290D0A202020207B0D0A202020202020202072657475726E206E65772053716C426F6F6C65616E2852656765782E49734D6174636828696E7075742E546F537472696E6728292C207061747465726E2E546F537472696E6728292C2052656765784F7074696F6E732E49676E6F72655061747465726E576869746573706163657C2052656765784F7074696F6E732E49676E6F72654361736529293B0D0A202020207D0D0A0D0A202020202F2FE69BBFE68DA2E5AD97E7ACA6E4B8B2E4B8ADE4B88EE68C87E5AE9AE79A84E58CB9E9858DE6A8A1E5BC8FE4B880E887B4E79A84E5AD97E7ACA6E4B8B2C2A00D0A202020205B53716C46756E6374696F6E5D0D0A202020207075626C6963207374617469632053716C537472696E672052656765785265706C6163652853716C537472696E6720696E7075742C2053716C537472696E67207061747465726E2C2053716C537472696E67207265706C6163656D656E74290D0A202020207B0D0A202020202020202072657475726E206E65772053716C537472696E672852656765782E5265706C61636528696E7075742E546F537472696E6728292C207061747465726E2E546F537472696E6728292C207265706C6163656D656E742E546F537472696E6728292C2052656765784F7074696F6E732E49676E6F72655061747465726E57686974657370616365207C2052656765784F7074696F6E732E49676E6F72654361736529293B0D0A202020207D0D0A0D0A7D3B0D0A0D0A AS N'RegexFun.cs', 0xEFBBBF7573696E672053797374656D2E5265666C656374696F6E3B0D0A7573696E672053797374656D2E52756E74696D652E436F6D70696C657253657276696365733B0D0A7573696E672053797374656D2E52756E74696D652E496E7465726F7053657276696365733B0D0A7573696E672053797374656D2E446174612E53716C3B0D0A0D0A2F2F2047656E6572616C20496E666F726D6174696F6E2061626F757420616E20617373656D626C7920697320636F6E74726F6C6C6564207468726F7567682074686520666F6C6C6F77696E670D0A2F2F20736574206F6620617474726962757465732E204368616E6765207468657365206174747269627574652076616C75657320746F206D6F646966792074686520696E666F726D6174696F6E0D0A2F2F206173736F636961746564207769746820616E20617373656D626C792E0D0A5B617373656D626C793A20417373656D626C795469746C65282253514C434C5222295D0D0A5B617373656D626C793A20417373656D626C794465736372697074696F6E282222295D0D0A5B617373656D626C793A20417373656D626C79436F6E66696775726174696F6E282222295D0D0A5B617373656D626C793A20417373656D626C79436F6D70616E7928224348494E4122295D0D0A5B617373656D626C793A20417373656D626C7950726F64756374282253514C434C5222295D0D0A5B617373656D626C793A20417373656D626C79436F707972696768742822436F7079726967687420C2A9204348494E41203230313322295D0D0A5B617373656D626C793A20417373656D626C7954726164656D61726B282222295D0D0A5B617373656D626C793A20417373656D626C7943756C74757265282222295D0D0A0D0A5B617373656D626C793A20436F6D56697369626C652866616C7365295D0D0A0D0A2F2F0D0A2F2F2056657273696F6E20696E666F726D6174696F6E20666F7220616E20617373656D626C7920636F6E7369737473206F662074686520666F6C6C6F77696E6720666F75722076616C7565733A0D0A2F2F0D0A2F2F2020202020204D616A6F722056657273696F6E0D0A2F2F2020202020204D696E6F722056657273696F6E0D0A2F2F2020202020204275696C64204E756D6265720D0A2F2F2020202020205265766973696F6E0D0A2F2F0D0A2F2F20596F752063616E207370656369667920616C6C207468652076616C756573206F7220796F752063616E2064656661756C7420746865205265766973696F6E20616E64204275696C64204E756D626572730D0A2F2F206279207573696E672074686520272A272061732073686F776E2062656C6F773A0D0A5B617373656D626C793A20417373656D626C7956657273696F6E2822312E302E2A22295D0D0A0D0A AS N'Properties\AssemblyInfo.cs';


GO
PRINT N'正在创建 [dbo].[RegexIsMatch]...';


GO
CREATE FUNCTION [dbo].[RegexIsMatch]
(@input NVARCHAR (4000), @pattern NVARCHAR (4000))
RETURNS BIT
AS
 EXTERNAL NAME [SQLCLR].[RegexFun].[RegexIsMatch]


GO
IF @@ERROR <> 0
   AND @@TRANCOUNT > 0
    BEGIN
        ROLLBACK;
    END

IF @@TRANCOUNT = 0
    BEGIN
        INSERT  INTO #tmpErrors (Error)
        VALUES                 (1);
        BEGIN TRANSACTION;
    END


GO
PRINT N'正在创建 [dbo].[RegexReplace]...';


GO
CREATE FUNCTION [dbo].[RegexReplace]
(@input NVARCHAR (4000), @pattern NVARCHAR (4000), @replacement NVARCHAR (4000))
RETURNS NVARCHAR (4000)
AS
 EXTERNAL NAME [SQLCLR].[RegexFun].[RegexReplace]


GO
IF @@ERROR <> 0
   AND @@TRANCOUNT > 0
    BEGIN
        ROLLBACK;
    END

IF @@TRANCOUNT = 0
    BEGIN
        INSERT  INTO #tmpErrors (Error)
        VALUES                 (1);
        BEGIN TRANSACTION;
    END


GO
PRINT N'正在创建 [SQLCLR].[SqlAssemblyProjectRoot]...';


GO
EXECUTE sp_addextendedproperty @name = N'SqlAssemblyProjectRoot', @value = N'F:\Loogn\SQLCLR', @level0type = N'Assembly', @level0name = N'SQLCLR';


GO
IF @@ERROR <> 0
   AND @@TRANCOUNT > 0
    BEGIN
        ROLLBACK;
    END

IF @@TRANCOUNT = 0
    BEGIN
        INSERT  INTO #tmpErrors (Error)
        VALUES                 (1);
        BEGIN TRANSACTION;
    END


GO
IF EXISTS (SELECT * FROM #tmpErrors) ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT>0 BEGIN
PRINT N'数据库更新的事务处理部分成功。'
COMMIT TRANSACTION
END
ELSE PRINT N'数据库更新的事务处理部分失败。'
GO
DROP TABLE #tmpErrors
GO
